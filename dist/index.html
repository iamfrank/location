<!doctype html>
<html class="no-js" lang="en" manifest="cache.manifest">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Location</title>
        <meta name="description" content="A simple web application to track and display geolocations">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        
        <!-- Enable iOS standalone mode for home screen -->
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-title" content="Geolocation App">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon" href="apple-touch-icon.png">

        <link rel="stylesheet" href="css/normalize.min.css">
        <link rel="stylesheet" href="css/leaflet.css">
        
        <style>
            
            * {
                box-sizing: border-box;
            }
            
            body {
                background-color: #122;
                color: #fff;
                font: 125%/1.3 Roboto, sans-serif;
            }
            
            dt {
                opacity: .66;
                font-size: smaller;
            }
            
            dd {
                margin: 0 0 .5rem;
                padding: 0;
            }
            
            nav {
                padding: .5rem;
            }
            
            nav * {
                display: inline-block;
            }
            
            a.btn,
            a.btn:link,
            a.btn:visited,
            button {
                color: teal;
                text-decoration: none;
                padding: .5rem;
                background-color: #233;
                border: solid .125rem;
                border-radius: .25rem;
            }
            
            a.btn:hover,
            a.btn:active,
            button:hover,
            button:active {
                background-color: #344;
            }
            
            #log,
            #routes {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100vh;
                overflow: auto;
                background-color: black;
                z-index: 1001;
                padding-bottom: 4rem;
            }
            
            #log:target,
            #routes:target {
                display: block;
            }
            
            #location {
                position: absolute;
                top: 0;
                right: 0;
                width: 25vw;
                height: 100vh;
                color: #000;
                z-index: 500;
                text-align: right;
                padding: .5rem;
                overflow: hidden;
            }
            
            #nav {
                position: absolute;
                z-index: 1002;
                bottom: 0;
                left: 0;
                width: 100%;
            }
            
            #routeslist {
                list-style: none;
                padding: 0;
            }
            
            #routeslist > li {
                display: flex;
                width: 100%;
            }
            
            #routeslist button:first-child {
                flex-grow: 1;
            }
            
            #maplayer {
                height: 100vh;
                width: 100%;
            }
            
            #trackcontrols {
                position: absolute;
                bottom: 4rem;
                left: .5rem;
                z-index: 501;
            }
            
            .spinner {
                animation: spinning .33s ease 0s infinite;
                display: inline-block;
                background-color: #fff;
                width: 0.125rem;
                height: 1rem;
                margin: 0 .5rem;
            }
            
            @keyframes spinning {
                0% { transform: rotate(0deg); }
                25% { transform: rotate(0deg); }
                50% { transform: rotate(90deg); }
                75% { transform: rotate(180deg); }
                100% { transform: rotate(180deg); }
            }
            
            
        </style>
        <link rel="manifest" href="manifest.json">
        <link rel="icon" href="apple-touch-icon.png" type="image/png">
    </head>
    <body>
        <main>
            
            <nav id="nav">
                <a class="btn" href="#">Map</a>
                <a class="btn" href="#log">Log</a>
                <a class="btn" href="#routes">Routes</a>
            </nav>
            
            <section id="location">
                <!-- <p>Retrieving location data <span class="spinner"></span></p> -->
            </section>
            
            <section id="log">
                <div id="loglist"></div>
            </section>
            
            <section id="routes">
                <ul id="routeslist"></ul>
            </section>
            
            <section id="map">
                <div id="trackcontrols">
                    <button onclick="geolocator.startTracking();">Start tracking</button>
                    <button onclick="geolocator.stopTracking();">Stop tracking</button>
                </div>
                <div id="maplayer"></div>
            </section>
            
        </main>
        
        <script src="js/leaflet.js"></script>
        <script>
            
            
            /*
            * Javascript for Geolocation webapp
            */
            var geolocator = (function() {
               
                var geo = {},
                    geo_map = L.map('maplayer').fitWorld(),
                    geo_routes = [],
                    geo_route = {
                        name: 'Undefined',
                        coords: []
                    },
                    geo_watch,
                    geo_options = {
                        enableHighAccuracy: true, 
                        maximumAge: 30000, 
                        timeout: 27000
                    };
                
                locdisplay = document.getElementById("location");
                logdisplay = document.getElementById("loglist");
                routedisplay = document.getElementById("routeslist");
                geo.init = init;
                geo.startTracking = startTracking;
                geo.stopTracking = stopTracking;
                geo.loadRoute = loadRoute;
                geo.deleteRoute = deleteRoute;
                
                /*
                var testroute = [
                    {
                        latitude: 55.11,
                        longitude: 12.00,
                        accuracy: 9000,
                        altitude: null,
                        altitudeAccuracy: null,
                        timestamp: null,
                        heading: 0,
                        speed: null
                    },
                    {
                        latitude: 55.12,
                        longitude: 12.01,
                        accuracy: 9000,
                        altitude: null,
                        altitudeAccuracy: null,
                        timestamp: null,
                        heading: 0,
                        speed: null
                    },
                    {
                        latitude: 55.13,
                        longitude: 12.02,
                        accuracy: 9000,
                        altitude: null,
                        altitudeAccuracy: null,
                        timestamp: null,
                        heading: 0,
                        speed: null
                    },
                    {
                        latitude: 55.14,
                        longitude: 12.00,
                        accuracy: 9000,
                        altitude: null,
                        altitudeAccuracy: null,
                        timestamp: null,
                        heading: 0,
                        speed: null
                    }
                ];
                geo_routes.push(testroute);
                */
                
                
                
                function init() {
                    if ("geolocation" in navigator) {
                        // Fetch already saved routes
                        if (typeof(Storage) !== "undefined" && localStorage.geolocatorSavedRoutes) {
                            geo_routes = JSON.parse(localStorage.geolocatorSavedRoutes);
                        } else {
                            // No support for web storage
                        }
                        L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            maxZoom: 18
                        }).addTo(geo_map);
                        geo_map.locate({
                            setView: true,
                            enableHighAccuracy: true
                        });
                        geo_map.on('locationfound', onLocationFound);
                        geo_map.on('locationerror', onLocationError);
                        listRoutes(geo_routes);
                    } else {
                        locdisplay.innerHTML = "Geolocation is not supported by this browser.";
                    }
                }
                
                function onLocationFound(e) {
                    var radius = e.accuracy / 2;
                    L.marker(e.latlng).addTo(geo_map).bindPopup("You are within " + radius + " meters from this point");
                    L.circle(e.latlng, radius).addTo(geo_map);
                    // Push current position to route
                    geo_route.coords.push({
                        latitude: e.latitude,
                        longitude: e.longitude
                    });
                    redrawMap(geo_route);
                    redrawLog(geo_route);
                    redrawLocationInfo(geo_route, e);
                }
                
                function onLocationError(e) {
                    alert(e.message);
                }
                
                function redrawMap(route) {
                    // Clear map
                    //geo_map.remove();
                    //geo_map = L.map('maplayer');
                    // Get positions for new map markers
                    var latlngs = [];
                    for (var c in route.coords) {
                        latlngs.push([ route.coords[c].latitude, route.coords[c].longitude ]);
                    }
                    // Draw the route
                    var polyline = L.polyline(latlngs, {color: 'blue'}).addTo(geo_map);
                    // zoom the map to the polyline
                    geo_map.fitBounds(polyline.getBounds());
                }
                
                function redrawLog(route) {
                    logdisplay.innerHTML = "<strong>" + route.name + "</strong><ol>";
                    for (var r in route.coords) {
                        logdisplay.innerHTML += "<li>latlong: " + route.coords[r].latitude + "," + route.coords[r].longitude + "</li>";    
                    }
                    logdisplay.innerHTML += "</ol>";
                }
                
                function redrawLocationInfo(route, coord) {
                    // Display geolocation data on screen
                    locdisplay.innerHTML = "<dl>"
                                + "<dt>Route</dt><dd>" + route.name + "</dd>"
                                + "<dt>Latitude</dt><dd>" + coord.latitude + "</dd>"
                                + "<dt>Longitude</dt><dd>" + coord.longitude + "</dd>"
                                + "</dl>";
                }
                
                function startTracking() {
                    geo_route = {
                        name: 'New route ' + geo_routes.length,
                        coords: []
                    };
                    geo_map.locate({
                        setView: true,
                        enableHighAccuracy: true,
                        watch: true
                    });
                }
                
                function stopTracking() {
                    geo_map.stopLocate();
                    geo_routes.push(geo_route);
                    saveRoutes(geo_routes);
                    listRoutes(geo_routes);
                }
                
                function saveRoutes(routes) {
                    localStorage.setItem("geolocatorSavedRoutes", JSON.stringify(routes));
                }
                
                /*
                function calculate_distance(lat1,lon1,lat2,lon2) {
                    var R = 6371; // Radius of the earth in km
                    var dLat = deg_to_rad(lat2-lat1);  // deg2rad below
                    var dLon = deg_to_rad(lon2-lon1); 
                    var a = 
                      Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(deg_to_rad(lat1)) * Math.cos(deg_to_rad(lat2)) * 
                      Math.sin(dLon/2) * Math.sin(dLon/2)
                      ; 
                    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
                    var d = R * c; // Distance in km
                    return d;
                }
                  
                function deg_to_rad(deg) {
                    return deg * (Math.PI/180);
                }
                */
                
                function listRoutes(routes) {
                    routedisplay.innerHTML = '';
                    for (var r in routes) {
                        routedisplay.innerHTML += '<li><button class="btn" onclick="geolocator.loadRoute(' + r + ')">' + routes[r].name + '</button><button class="btn" onclick="geolocator.deleteRoute(' + r + ')">Delete</button></li>';
                    }
                }
                
                function loadRoute(route_id) {
                    location.hash = '';
                    geo_route = geo_routes[route_id];
                    redrawLog(geo_route);
                    console.log('route info');
                    console.log(geo_route.coords);
                    redrawLocationInfo(geo_route, geo_route.coords[geo_route.coords.length - 1]);
                    redrawMap(geo_route);
                }
                
                function deleteRoute(route_id) {
                    if (confirm('Delete?')) {
                        geo_routes.splice(route_id, 1);
                        saveRoutes(geo_routes);
                        listRoutes(geo_routes);    
                    }
                }
                
                return geo;
            
            }());
           
            geolocator.init();
           
           
            /*
             * Register service worker
             * (Does nothing at present. Is needed to display Chrome install web app banner.)
             */
            var service_worker = (function() {
                
                var sw = {};
                
                sw.init = init;
                
                function init() {
                    if ('serviceWorker' in navigator) {
                      window.addEventListener('load', function() {
                        navigator.serviceWorker.register('sw.js').then(function(registration) {
                          // Registration was successful
                          console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        }).catch(function(err) {
                          // registration failed :(
                          console.log('ServiceWorker registration failed: ', err);
                        });
                      });
                    }
                }
                
                return sw;
                
            }());
            
            service_worker.init();

            
        </script>
    </body>
</html>
