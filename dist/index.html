<!doctype html>
<html class="no-js" lang="en" manifest="cache.manifest">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Location</title>
        <meta name="description" content="A simple web application to track and display geolocations">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        
        <!-- Enable iOS standalone mode for home screen -->
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-title" content="Geolocation App">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon" href="apple-touch-icon.png">

        <link rel="stylesheet" href="css/normalize.min.css">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css"
              integrity="sha512-wcw6ts8Anuw10Mzh9Ytw4pylW8+NAD4ch3lqm9lzAsTxg0GFeJgoAtxuCLREZSC5lUXdVyo/7yfsqFjQ4S+aKw=="
              crossorigin="">
        
        <style>
            
            
            body {
                background-color: #122;
                color: #fff;
                font: 125%/1.3 Roboto, sans-serif;
            }
            
            dt {
                opacity: .66;
                font-size: smaller;
            }
            
            dd {
                margin: 0 0 .5rem;
                padding: 0;
            }
            
            a.btn,
            a.btn:link,
            a.btn:visited,
            button {
                color: teal;
                text-decoration: none;
                padding: .5rem;
                background-color: #233;
                border: solid .125rem;
                border-radius: .25rem;
            }
            
            a.btn:hover,
            a.btn:active,
            button:hover,
            button:active {
                background-color: #344;
            }
            
            #log,
            #routes {
                display: none;
                position: fixed;
                top: 3rem;
                left: 0;
                width: 100%;
                height: calc(100% - 3rem);
                overflow: auto;
                background-color: black;
                z-index: 501;
            }
            
            #log:target,
            #routes:target {
                display: block;
            }
            
            #location {
                position: absolute;
                top: 0;
                right: 0;
                width: 33vw;
                height: 100vh;
                color: #000;
                z-index: 500;
                text-align: right;
                padding: .5rem;
                box-sizing: border-box;
            }
            
            #actions {
                position: absolute;
                z-index: 502;
                bottom: 0;
                left: 0;
                width: 100%;
            }
            
            #map {
                height: 100vh;
                width: 100%;
            }
            
            .spinner {
                animation: spinning .33s ease 0s infinite;
                display: inline-block;
                background-color: #fff;
                width: 0.125rem;
                height: 1rem;
                margin: 0 .5rem;
            }
            
            @keyframes spinning {
                0% { transform: rotate(0deg); }
                25% { transform: rotate(0deg); }
                50% { transform: rotate(90deg); }
                75% { transform: rotate(180deg); }
                100% { transform: rotate(180deg); }
            }
            
            
        </style>
        <link rel="manifest" href="manifest.json">
        <link rel="icon" href="apple-touch-icon.png" type="image/png">
    </head>
    <body>
        <main>
            
            <nav id="actions">
                <button onclick="geolocator.start_tracking();">Start tracking</button>
                <button onclick="geolocator.stop_tracking();">Stop tracking</button>
                <a class="btn" href="#">Map</a>
                <a class="btn" href="#log">Log</a>
                <a class="btn" href="#routes">Routes</a>
            </nav>
            
            <section id="location">
                <p>Retrieving location data <span class="spinner"></span></p>
            </section>
            
            <section id="log">
                <ol id="loglist"></ol>
            </section>
            
            <section id="routes">
                <ul id="routeslist"></ul>
            </section>
            
            <div id="map"></div>
            
        </main>
        
        <script src="https://unpkg.com/leaflet@1.1.0/dist/leaflet.js"
                integrity="sha512-mNqn2Wg7tSToJhvHcqfzLMU6J4mkOImSPTxVZAdo+lcPlk+GhZmYgACEe0x35K7YzW1zJ7XyJV/TT1MrdXvMcA=="
                crossorigin="">
        </script>
        <script>
            
            
            /*
            * Javascript for Geolocation webapp
            */
            var geolocator = (function() {
               
                var geo = {},
                    geo_map = L.map('map').fitWorld(),
                    geo_route = [],
                    geo_routes = [],
                    geo_watch,
                    geo_options = {
                        enableHighAccuracy: true, 
                        maximumAge: 30000, 
                        timeout: 27000
                    };
                
                locdisplay = document.getElementById("location");
                logdisplay = document.getElementById("loglist");
                routedisplay = document.getElementById("routes");
                geo.init = init;
                geo.start_tracking = start_tracking;
                geo.stop_tracking = stop_tracking;
                geo.load_route = load_route;
                
                /*
                var testroute = [
                    {
                        latitude: 55.11,
                        longitude: 12.00,
                        accuracy: 9000,
                        altitude: null,
                        altitudeAccuracy: null,
                        timestamp: null,
                        heading: 0,
                        speed: null
                    },
                    {
                        latitude: 55.12,
                        longitude: 12.01,
                        accuracy: 9000,
                        altitude: null,
                        altitudeAccuracy: null,
                        timestamp: null,
                        heading: 0,
                        speed: null
                    },
                    {
                        latitude: 55.13,
                        longitude: 12.02,
                        accuracy: 9000,
                        altitude: null,
                        altitudeAccuracy: null,
                        timestamp: null,
                        heading: 0,
                        speed: null
                    },
                    {
                        latitude: 55.14,
                        longitude: 12.00,
                        accuracy: 9000,
                        altitude: null,
                        altitudeAccuracy: null,
                        timestamp: null,
                        heading: 0,
                        speed: null
                    }
                ];
                geo_routes.push(testroute);
                */
                
                
                
                function init() {
                    if ("geolocation" in navigator) {
                        // Fetch already saved routes
                        if (typeof(Storage) !== "undefined" && localStorage.geolocatorSavedRoutes) {
                            geo_routes = JSON.parse(localStorage.geolocatorSavedRoutes);
                        } else {
                            // No support for web storage
                        }
                        L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            maxZoom: 18
                        }).addTo(geo_map);
                        getLocation();
                        listRoutes(geo_routes);
                    } else {
                        locdisplay.innerHTML = "Geolocation is not supported by this browser.";
                    }
                }
                
                function getLocation() {
                    navigator.geolocation.getCurrentPosition(geo_success, geo_error, geo_options);
                }
                
                function geo_success(position) {
                    // Display geolocation data on screen
                    locdisplay.innerHTML = "<dl><dt>Latitude</dt><dd>" + position.coords.latitude + "</dd>"
                                + "<dt>Longitude</dt><dd>" + position.coords.longitude + "</dd>"
                                + "<dt>Accuracy</dt><dd>" + position.coords.accuracy + "</dd>"
                                + "<dt>Altitude</dt><dd>" + position.coords.altitude + "</dd>"
                                + "<dt>Altitude accuracy</dt><dd>" + position.coords.altitudeAccuracy + "</dd>"
                                + "<dt>Heading</dt><dd>" + position.coords.heading + "</dd>"
                                + "<dt>Timestamp</dt><dd>" + position.coords.timestamp + "</dd>"
                                + "</dl>";
                    // Push current position to route
                    geo_route.push({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        altitude: position.coords.altitude,
                        altitudeAccuracy: position.coords.altitudeAccuracy,
                        timestamp: position.coords.timestamp,
                        heading: position.coords.heading,
                        speed: position.coords.speed
                    });
                    redraw_log();
                    redraw_map(geo_route)
                }
                
                function geo_error(error) {
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            locdisplay.innerHTML = "User denied the request for Geolocation."
                            break;
                        case error.POSITION_UNAVAILABLE:
                            locdisplay.innerHTML = "Location information is unavailable."
                            break;
                        case error.TIMEOUT:
                            locdisplay.innerHTML = "The request to get user location timed out."
                            break;
                        case error.UNKNOWN_ERROR:
                            locdisplay.innerHTML = "An unknown error occurred."
                            break;
                        default:
                            locdisplay.innerHTML = "Something strange is going on."
                    }
                }
                
                function redraw_map(route) {
                    // Update map with current route and current position
                    var latlngs = [];
                    for (var c in route) {
                        latlngs.push([[route[c].latitude, route[c].longitude]]);
                    }
                    // Add marker for last known position
                    console.log('route info');
                    console.log(route);
                    console.log(route.length);
                    L.marker([ route[route.length - 1].latitude, route[route.length - 1].longitude ]).addTo(geo_map);
                    // Draw the route
                    var polyline = L.polyline(latlngs, {color: 'red'}).addTo(geo_map);
                    // zoom the map to the polyline
                    geo_map.fitBounds(polyline.getBounds());
                }
                
                function redraw_log() {
                    for (var g in geo_route) {
                        logdisplay.innerHTML += "<li>latlong: " + geo_route[g].latitude + "," + geo_route[g].longitude + "; acc:" + geo_route[g].accuracy + "; time: " + geo_route[g].timestamp + "</li>";    
                    }
                }
                
                function start_tracking() {
                    geo_route = [];
                    geo_watch = navigator.geolocation.watchPosition(geo_success, geo_error, geo_options);
                }
                
                function stop_tracking() {
                    navigator.geolocation.clearWatch(geo_watch);
                    geo_routes.push(geo_route);
                    localStorage.setItem("geolocatorSavedRoutes", JSON.stringify(geo_routes));
                }
                
                function calculate_distance(lat1,lon1,lat2,lon2) {
                    var R = 6371; // Radius of the earth in km
                    var dLat = deg_to_rad(lat2-lat1);  // deg2rad below
                    var dLon = deg_to_rad(lon2-lon1); 
                    var a = 
                      Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(deg_to_rad(lat1)) * Math.cos(deg_to_rad(lat2)) * 
                      Math.sin(dLon/2) * Math.sin(dLon/2)
                      ; 
                    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
                    var d = R * c; // Distance in km
                    return d;
                }
                  
                function deg_to_rad(deg) {
                    return deg * (Math.PI/180);
                }
                
                function listRoutes(routes) {
                    for (var r in routes) {
                        routedisplay.innerHTML += '<li><button class="btn" onclick="geolocator.load_route(' + r + ')">' + r + '</button></li>';
                    }
                }
                
                function load_route(route_id) {
                    location.hash = '';
                    geo_route = geo_routes[route_id];
                    redraw_log();
                    redraw_map();
                }
                
                return geo;
            
            }());
           
            geolocator.init();
           
           
            /*
             * Register service worker
             * (Does nothing at present. Is needed to display Chrome install web app banner.)
             */
            var service_worker = (function() {
                
                var sw = {};
                
                sw.init = init;
                
                function init() {
                    if ('serviceWorker' in navigator) {
                      window.addEventListener('load', function() {
                        navigator.serviceWorker.register('sw.js').then(function(registration) {
                          // Registration was successful
                          console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        }).catch(function(err) {
                          // registration failed :(
                          console.log('ServiceWorker registration failed: ', err);
                        });
                      });
                    }
                }
                
                return sw;
                
            }());
            
            service_worker.init();

            
        </script>
    </body>
</html>
