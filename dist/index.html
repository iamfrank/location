<!doctype html>
<html class="no-js" lang="en" manifest="cache.manifest">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Location</title>
        <meta name="description" content="A simple web application to track and display geolocations">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        
        <!-- Enable iOS standalone mode for home screen -->
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-title" content="Geolocation App">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon" href="apple-touch-icon.png">

        <link rel="stylesheet" href="css/normalize.min.css">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css" integrity="sha512-wcw6ts8Anuw10Mzh9Ytw4pylW8+NAD4ch3lqm9lzAsTxg0GFeJgoAtxuCLREZSC5lUXdVyo/7yfsqFjQ4S+aKw==" crossorigin="">
        
        <style>
            
            
            body {
                background-color: #122;
                color: #fff;
                font: 125%/1.3 Roboto, sans-serif;
                padding: 2rem;
            }
            
            dt {
                opacity: .66;
                font-size: smaller;
            }
            
            dd {
                margin: 0 0 .5rem;
                padding: 0;
            }
            
            #map {
                height: 60vh;
            }
            
            .spinner {
                animation: spinning .33s ease 0s infinite;
                display: inline-block;
                background-color: #fff;
                width: 0.125rem;
                height: 1rem;
                margin: 0 .5rem;
            }
            
            @keyframes spinning {
                0% { transform: rotate(0deg); }
                25% { transform: rotate(0deg); }
                50% { transform: rotate(90deg); }
                75% { transform: rotate(180deg); }
                100% { transform: rotate(180deg); }
            }
            
            
        </style>
        <link rel="manifest" href="manifest.json">
        <link rel="icon" href="apple-touch-icon.png" type="image/png">
    </head>
    <body>
        <main>
            
            <div id="location">
                <p>Retrieving location data <span class="spinner"></span></p>
            </div>
            
            <h2>Log</h2>
            <div id="log"></div>
            
            <div id="map"></div>
            
        </main>
        
        <script src="https://unpkg.com/leaflet@1.1.0/dist/leaflet.js" integrity="sha512-mNqn2Wg7tSToJhvHcqfzLMU6J4mkOImSPTxVZAdo+lcPlk+GhZmYgACEe0x35K7YzW1zJ7XyJV/TT1MrdXvMcA==" crossorigin=""></script>
        <script>
            
            
            /*
            * Javascript for Geolocation webapp
            */
            var geolocator = (function() {
               
                var geo = {},
                    geo_map = L.map('map').fitWorld(),
                    geo_route = [];
                
                locdisplay = document.getElementById("location");
                logdisplay = document.getElementById("log");
                geo.init = init;
                
                function init() {
                    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 18
                    }).addTo(geo_map);
                    getLocation();
                }
                
                function getLocation() {
                    if ("geolocation" in navigator) {
                        navigator.geolocation.watchPosition(geo_success, geo_error);
                    } else {
                        locdisplay.innerHTML = "Geolocation is not supported by this browser.";
                    }
                }
                
                function geo_success(position) {
                    // Make accuracy value human readable
                    var accuracy = position.coords.accuracy + 'm';
                    if (position.coords.accuracy < 10) {
                        accuracy = '~ 10m';
                    } else if (position.coords.accuracy < 50) {
                        accuracy = '~ 50m';
                    } else if (position.coords.accuracy < 100) {
                        accuracy = '~ 100m';
                    } else if (position.coords.accuracy < 200) {
                        accuracy = '~ 200m';
                    } else if (position.coords.accuracy < 500) {
                        accuracy = '~ 500m';
                    } else if (position.coords.accuracy < 1000) {
                        accuracy = '~ 1km';
                    } else if (position.coords.accuracy < 10000) {
                        accuracy = '~ 10km';
                    } else if (position.coords.accuracy < 50000) {
                        accuracy = 'not great <span style="opacity: .75;">( ~ 50km )</span>';
                    } else if (position.coords.accuracy >= 50000) {
                        accuracy = 'terrible <span style="opacity: .75;">( 50km+ )</span>';
                    }
                    // Display geolocation data on screen
                    locdisplay.innerHTML = "<dl><dt>Latitude</dt><dd>" + position.coords.latitude + "</dd>"
                                + "<dt>Longitude</dt><dd>" + position.coords.longitude + "</dd>"
                                + "<dt>Accuracy</dt><dd>" + accuracy + "</dd>";
                    if (position.coords.altitude !== null) {
                        locdisplay.innerHTML += "<dt>Altitude</dt><dd>" + position.coords.altitude + "</dd>";
                    }
                    if (position.coords.altitudeAccuracy !== null) {
                        locdisplay.innerHTML += "<dt>Altitude accuracy</dt><dd>" + position.coords.altitudeAccuracy + "</dd>";
                    }
                    if (position.coords.heading !== null) {
                        locdisplay.innerHTML += "<dt>Heading</dt><dd>" + position.coords.heading + "</dd>";
                    }
                    if (position.coords.timestamp !== undefined) {
                        locdisplay.innerHTML += "<dt>Timestamp</dt><dd>" + position.coords.timestamp + "</dd>";
                    }
                    locdisplay.innerHTML += "</dl>";
                    // Update map with current location
                    L.marker([position.coords.latitude, position.coords.longitude]).addTo(geo_map);
                    // Push current position to route
                    geo_route.push(position.coords);
                    geo_redraw_log();
                }
                
                function geo_error(error) {
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            locdisplay.innerHTML = "User denied the request for Geolocation."
                            break;
                        case error.POSITION_UNAVAILABLE:
                            locdisplay.innerHTML = "Location information is unavailable."
                            break;
                        case error.TIMEOUT:
                            locdisplay.innerHTML = "The request to get user location timed out."
                            break;
                        case error.UNKNOWN_ERROR:
                            locdisplay.innerHTML = "An unknown error occurred."
                            break;
                        default:
                            locdisplay.innerHTML = "Something strange is going on."
                    }
                }
                
                function geo_redraw_log() {
                    logdisplay.innerHTML = "<ol>";
                    for (var g in geo_route) {
                        logdisplay.innerHTML += "<li> " + geo_route[g].latitude + "," + geo_route[g].longitude + " </li>";    
                    }
                    logdisplay.innerHTML += "</ol>";
                }
                
                return geo;
            
            }());
           
            geolocator.init();
           
           
            /*
             * Register service worker
             * (Does nothing at present. Is needed to display Chrome install web app banner.)
             */
            var service_worker = (function() {
                
                var sw = {};
                
                sw.init = init;
                
                function init() {
                    if ('serviceWorker' in navigator) {
                      window.addEventListener('load', function() {
                        navigator.serviceWorker.register('../dist/sw.js').then(function(registration) {
                          // Registration was successful
                          console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        }).catch(function(err) {
                          // registration failed :(
                          console.log('ServiceWorker registration failed: ', err);
                        });
                      });
                    }
                }
                
                return sw;
                
            }());
            
            service_worker.init();

            
        </script>
    </body>
</html>
