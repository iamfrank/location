<!doctype html>
<html class="no-js" lang="en" manifest="cache.manifest">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Location</title>
        <meta name="description" content="A simple web application to track and display geolocations">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        
        <!-- Enable iOS standalone mode for home screen -->
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-title" content="Geolocation App">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon" href="apple-touch-icon.png">

        <link rel="stylesheet" href="css/normalize.min.css">
        <link rel="stylesheet" href="css/leaflet.css">
        
        <style>
            
            * {
                box-sizing: border-box;
            }
            
            body {
                background-color: #122;
                color: #fff;
                font: 125%/1.3 Roboto, sans-serif;
            }
            
            dt {
                opacity: .66;
                font-size: smaller;
            }
            
            dd {
                margin: 0 0 .5rem;
                padding: 0;
            }
            
            nav {
                padding: .5rem;
            }
            
            nav * {
                display: inline-block;
            }
            
            a.btn,
            a.btn:link,
            a.btn:visited,
            button {
                color: teal;
                text-decoration: none;
                padding: .5rem;
                background-color: #233;
                border: solid .125rem;
                border-radius: .25rem;
            }
            
            a.btn:hover,
            a.btn:active,
            button:hover,
            button:active {
                background-color: #344;
            }
            
            #log,
            #routes {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100vh;
                overflow: auto;
                background-color: black;
                z-index: 1001;
                padding-bottom: 4rem;
            }
            
            #log:target,
            #routes:target {
                display: block;
            }
            
            #location {
                position: absolute;
                top: 0;
                right: 0;
                width: 25vw;
                height: 100vh;
                color: #000;
                z-index: 500;
                text-align: right;
                padding: .5rem;
                overflow: hidden;
            }
            
            #nav {
                position: absolute;
                z-index: 1002;
                bottom: 0;
                left: 0;
                width: 100%;
            }
            
            #routeslist {
                list-style: none;
                padding: 0;
            }
            
            #routeslist > li {
                display: flex;
                width: 100%;
            }
            
            #routeslist button:first-child {
                flex-grow: 1;
            }
            
            #maplayer {
                height: 100vh;
                width: 100%;
            }
            
            #trackcontrols {
                position: absolute;
                bottom: 4rem;
                left: .5rem;
                z-index: 501;
            }
            
            .spinner {
                animation: spinning .33s ease 0s infinite;
                display: inline-block;
                background-color: #fff;
                width: 0.125rem;
                height: 1rem;
                margin: 0 .5rem;
            }
            
            @keyframes spinning {
                0% { transform: rotate(0deg); }
                25% { transform: rotate(0deg); }
                50% { transform: rotate(90deg); }
                75% { transform: rotate(180deg); }
                100% { transform: rotate(180deg); }
            }
            
            
        </style>
        <link rel="manifest" href="manifest.json">
        <link rel="icon" href="apple-touch-icon.png" type="image/png">
    </head>
    <body>
        <main>
            
            <nav id="nav">
                <a class="btn" href="#">Map</a>
                <a class="btn" href="#log">Log</a>
                <a class="btn" href="#routes">Routes</a>
            </nav>
            
            <section id="location">
                <!-- <p>Retrieving location data <span class="spinner"></span></p> -->
            </section>
            
            <section id="log">
                <div id="loglist"></div>
            </section>
            
            <section id="routes">
                <ul id="routeslist"></ul>
            </section>
            
            <section id="map">
                <div id="trackcontrols">
                    <button onclick="geolocator.startTracking();">Start tracking</button>
                    <button onclick="geolocator.stopTracking();">Stop tracking</button>
                </div>
                <div id="maplayer"></div>
            </section>
            
        </main>
        
        <script src="js/leaflet.js"></script>
        <script>
            
            
            /*
            * Javascript for Geolocation webapp
            */
            var geolocator = (function() {
               
                var geo = {},
                    geo_map = L.map('maplayer').fitWorld(),
                    geo_routes = [],
                    geo_route = {
                        name: 'Undefined',
                        coords: [],
                        distance: 0
                    },                    
                    geo_map_marker,
                    geo_map_circle,
                    geo_map_polyline,
                    locdisplay = document.getElementById("location"),
                    logdisplay = document.getElementById("loglist"),
                    routedisplay = document.getElementById("routeslist");
                
                geo.init = init;
                geo.startTracking = startTracking;
                geo.stopTracking = stopTracking;
                geo.loadRoute = loadRoute;
                geo.deleteRoute = deleteRoute;
                
                function init() {
                    // Fetch already saved routes
                    if (typeof(Storage) !== "undefined" && localStorage.geolocatorSavedRoutes) {
                        geo_routes = JSON.parse(localStorage.geolocatorSavedRoutes);
                    } else {
                        // No support for web storage
                    }
                    // Initialize map and location listeners
                    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 18
                    }).addTo(geo_map);
                    geo_map.locate({
                        setView: true,
                        enableHighAccuracy: true
                    });
                    geo_map.on('locationfound', onLocationFound);
                    geo_map.on('locationerror', onLocationError);
                    // List routes
                    listRoutes(geo_routes);
                    
                    /*
                    var testroute = {
                        name: 'Testroute',
                        coords: [
                            {
                                latitude: 55.11,
                                longitude: 12.00,
                                distance: 0,
                                accuracy: 80
                            },
                            {
                                latitude: 55.12,
                                longitude: 12.01,
                                distance: 4,
                                accuracy: 80
                            },
                            {
                                latitude: 55.13,
                                longitude: 12.02,
                                distance: 3,
                                accuracy: 80
                            },
                            {
                                latitude: 55.14,
                                longitude: 12.00,
                                distance: 10,
                                accuracy: 80
                            }
                        ],
                        distance: 17
                    };
                    geo_routes.push(testroute);
                    */
                    
                }
                
                function onLocationFound(e) {
                    // Get prior coord to compare
                    var pre_coord = geo_route.coords[geo_route.coords.length - 1];
                    var dist;
                    if (pre_coord) {
                        dist = geo_map.distance( [e.latitude, e.longitude], [pre_coord.latitude, pre_coord.longitude] );
                        console.log('distance');
                        console.log(geo_map.distance( [e.latitude, e.longitude], [pre_coord.latitude, pre_coord.longitude] ));
                    } else {
                        dist = 0;
                    }
                    // Push position to current route
                    geo_route.coords.push({
                        latitude: e.latitude,
                        longitude: e.longitude,
                        distance: dist,
                        accuracy: e.accuracy
                    });
                    redrawMap(geo_route);
                    redrawLog(geo_route);
                    redrawLocationInfo(geo_route);
                }
                
                function onLocationError(e) {
                    alert(e.message);
                }
                
                function redrawMap(route) {
                    // Clean up map
                    if (geo_map_marker !== undefined) {
                        geo_map_marker.remove();    
                    }
                    if (geo_map_circle !== undefined) {
                        geo_map_circle.remove();
                    }
                    if (geo_map_polyline !== undefined) {
                        geo_map_polyline.remove();    
                    }
                    // Get positions for new map markers
                    var latlngs = [];
                    for (var c in route.coords) {
                        latlngs.push([ route.coords[c].latitude, route.coords[c].longitude ]);
                        // Now we're at it, add the distances together
                        route.distance += route.coords[c].distance;
                    }
                    // Draw the route
                    geo_map_polyline = L.polyline(latlngs, {color: 'blue'}).addTo(geo_map);
                    // zoom the map to the polyline
                    geo_map.fitBounds(geo_map_polyline.getBounds());
                    // Redraw the current position
                    var radius = route.coords[route.coords.length - 1].accuracy / 2;
                    var latlng = [ route.coords[route.coords.length - 1].latitude, route.coords[route.coords.length - 1].longitude ];
                    geo_map_marker = L.marker(latlng).addTo(geo_map).bindPopup("You are within " + radius + " meters from this point");
                    geo_map_circle = L.circle(latlng, radius).addTo(geo_map);
                }
                
                function redrawLog(route) {
                    logdisplay.innerHTML = "<strong>" + route.name + "</strong>";
                    for (var r in route.coords) {
                        logdisplay.innerHTML += "<p>latlong: " + route.coords[r].latitude + "," + route.coords[r].longitude + "; distance: " + route.coords[r].distance + "</p>";    
                    }
                }
                
                function redrawLocationInfo(route) {
                    // Display geolocation data on screen
                    var coord = route.coords[route.coords.length - 1];
                    locdisplay.innerHTML = "<dl>"
                                + "<dt>Route</dt><dd>" + route.name + "</dd>"
                                + "<dt>Latitude</dt><dd>" + coord.latitude + "</dd>"
                                + "<dt>Longitude</dt><dd>" + coord.longitude + "</dd>"
                                + "<dt>Distance</dt><dd>" + route.distance + "m</dd>"
                                + "</dl>";
                }
                
                function startTracking() {
                    geo_route = {
                        name: 'New route ' + geo_routes.length,
                        coords: []
                    };
                    geo_map.locate({
                        setView: true,
                        enableHighAccuracy: true,
                        watch: true
                    });
                }
                
                function stopTracking() {
                    geo_map.stopLocate();
                    geo_routes.push(geo_route);
                    saveRoutes(geo_routes);
                    listRoutes(geo_routes);
                }
                
                function saveRoutes(routes) {
                    localStorage.setItem("geolocatorSavedRoutes", JSON.stringify(routes));
                }
                
                function listRoutes(routes) {
                    routedisplay.innerHTML = '';
                    for (var r in routes) {
                        routedisplay.innerHTML += '<li><button class="btn" onclick="geolocator.loadRoute(' + r + ')">' + routes[r].name + '</button><button class="btn" onclick="geolocator.deleteRoute(' + r + ')">Delete</button></li>';
                    }
                }
                
                function loadRoute(route_id) {
                    location.hash = '';
                    geo_route = geo_routes[route_id];
                    redrawLog(geo_route);
                    redrawLocationInfo(geo_route, geo_route.coords[geo_route.coords.length - 1]);
                    redrawMap(geo_route);
                }
                
                function deleteRoute(route_id) {
                    if (confirm('Delete?')) {
                        geo_routes.splice(route_id, 1);
                        saveRoutes(geo_routes);
                        listRoutes(geo_routes);    
                    }
                }
                
                return geo;
            
            }());
           
            geolocator.init();
           
           
            /*
             * Register service worker
             * (Does nothing at present. Is needed to display Chrome install web app banner.)
             */
            var service_worker = (function() {
                
                var sw = {};
                
                sw.init = init;
                
                function init() {
                    if ('serviceWorker' in navigator) {
                      window.addEventListener('load', function() {
                        navigator.serviceWorker.register('sw.js').then(function(registration) {
                          // Registration was successful
                          console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        }).catch(function(err) {
                          // registration failed :(
                          console.log('ServiceWorker registration failed: ', err);
                        });
                      });
                    }
                }
                
                return sw;
                
            }());
            
            service_worker.init();

            
        </script>
    </body>
</html>
