<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Locator</title>
        <meta name="description" content="A web application to track and display geolocations">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" href="./modules/leaflet/leaflet.css">
        <script src="./modules/leaflet/leaflet.js"></script>

        <style>

            * {
                box-sizing: border-box;
            }

            html,
            body {
                height: 100%;
                width: 100%;
            }

            body {
                margin: 0;
                padding: 0;
            }

            main {
                bottom: 0;
                font: 1em/1.2 sans-serif;
                left: 0;
                position: fixed;
                right: 0;
                top: 0;
            }
            
            button {
                background-color: #000;
                border: none;
                border-radius: 50%;
                box-shadow: 0 .25rem .5rem hsla(0,0%,50%,.5);
                color: #fff;
                font-size: .9rem;
                height: 3rem;
                line-height: 1;
                padding: .25rem .25rem;
                position: absolute;
                text-align: center;
                width: 3rem;
                z-index: 3;
                text-transform: uppercase;
            }

            #get-position {
                bottom: 2rem;
                right: 2rem;
            }

            #set-position {
                bottom: 6rem;
                right: 2rem;
            }

            #info-panel {
                background-color: #eee;
                left: 0;
                padding: 0 2rem;
                position: absolute;
                right: 0;
                bottom: 0;
                z-index: 2;
            }

            .info-accuracy {
                color: #999;
                margin: 0;
                padding: 0;
            }

            #map {
                width: 100vw;
                height: 100vh;
                position: absolute;
                top: 0;
                bottom: 0;
                right: 0;
                left: 0;
                z-index: 1;
            }

        </style>
        
    </head>
    <body>

        <main id="locator">

            <div id="map"></div>
            
            <div id="info-panel"></div>

            <button id="get-position" title="Get location">Get</button>
            
            <button id="set-position" title="Save location">Set</button>
            
        </main>

        <script>

            /*
             * HTML elements
             */

            let pos_btn = document.getElementById('get-position'),
                set_btn = document.getElementById('set-position'),
                info_panel = document.getElementById('info-panel')


            /*
             * Properties
             */
            
            let flag_user_has_zoomed = false,
                flag_is_tracking = false,
                geo_options = {
                    enableHighAccuracy: true, 
                    maximumAge: 30000, 
                    timeout: 27000
                },
                pos_watcher = null,
                position_now = {
                    coords: {
                        latitude: 55,
                        longitude: 11
                    }
                },
                positions = [],
                ui_map = null,
                ui_map_marker = null

            const icon = L.icon({
                iconUrl: './img/logo_v3_small.svg',
                iconSize: [30, 45],
                iconAnchor: [15, 45],
                popupAnchor: [0, -30],
            })


            /*
             * Methods
             */

            function accuracyDigester(accuracy) {
                let acc_obj = {
                    display: '',
                    zoom: 1
                }
                if (accuracy < 1) {
                    acc_obj.display = `< 1m`
                } else if (accuracy < 1000) {
                    acc_obj.display = `~ ${ accuracy.toFixed(0) }m`
                } else {
                    acc_obj.display = `~ ${ (accuracy / 1000).toFixed(1) }km`   
                }
                if (accuracy < 50) {
                    acc_obj.zoom = 19
                } else if (accuracy < 150) {
                    acc_obj.zoom = 18
                } else if (accuracy < 250) {
                    acc_obj.zoom = 17
                } else if (accuracy < 500) {
                    acc_obj.zoom = 16
                } else if (accuracy < 1000) {
                    acc_obj.zoom = 15
                } else if (accuracy < 2500) {
                    acc_obj.zoom = 14
                } else if (accuracy < 5000) {
                    acc_obj.zoom = 13
                } else if (accuracy < 10000) {
                    acc_obj.zoom = 12
                } else if (accuracy < 15000) {
                    acc_obj.zoom = 11
                } else if (accuracy < 25000) {
                    acc_obj.zoom = 10
                } else if (accuracy < 50000) {
                    acc_obj.zoom = 9
                } else if (accuracy < 150000) {
                    acc_obj.zoom = 8
                } else if (accuracy < 250000) {
                    acc_obj.zoom = 7
                } else {
                    acc_obj.zoom = 6
                }
                return acc_obj
            }

            function renderPosition(position) {
                const lat = position.coords.latitude,
                      lng = position.coords.longitude
                let str = 'Tracking current location<br>'
                if (lat > 0) {
                    str += 'N ' + lat.toFixed(4) + '&#176;<br>'
                } else if (lat < 0) {
                    str += 'S ' + lat.toFixed(4) + '&#176;<br>'
                } else {
                    str = '0&#176;<br>'
                }
                if (lng > 0) {
                    str += 'E ' + lng.toFixed(4) + '&#176;'
                } else if (lng < 0) {
                    str += 'W ' + lng.toFixed(4) + '&#176;'
                } else {
                    str += '0&#176;'
                }
                str += '<p class="info-accuracy">Accuracy: ' + accuracyDigester(position.coords.accuracy).display + '</p>'
                info_panel.innerHTML = str
            }

            function updateMap(position) {
                const lat = position.coords.latitude,
                      lng = position.coords.longitude

                let zoom = ui_map.getZoom()
                if (!flag_user_has_zoomed) {
                    zoom = accuracyDigester(position.coords.accuracy).zoom
                }
                ui_map_marker.setLatLng([lat, lng])
                ui_map.setView([lat, lng], zoom)
            }

            function geo_success(position) {
                position_now = position
                renderPosition(position)
                updateMap(position)
            }

            function geo_error() {
                info_panel.innerHTML = "No location available :-("
            }

            function deletePosition(position_time_id) {
                var idx = positions.findIndex(function(p) {
                    return p.time === position_time_id
                })
                positions[idx].marker.remove()
                positions.splice(idx, 1)
                savePositions(positions)
            }

            function renderMarkers(positions) {
                for (var pos in positions) {
                    let new_marker = L.marker([positions[pos].lat, positions[pos].lng], {icon: icon})
                    .bindPopup('A lovely popup. <button onclick="deletePosition(' + positions[pos].time + ')">Remove</button>')
                    .addTo(ui_map)
                    positions[pos].marker = new_marker
                }
            }

            function savePositions(arr) {
                let save_arr = arr.map(pos => {
                    return Object.assign({}, pos)
                })
                
                save_arr.map(function(pos) {
                    pos.marker = null
                })
                localStorage.setItem('locator-positions-7718522f6d83', JSON.stringify(save_arr))
            }

            function setGeoPos() {
                flag_is_tracking = false
                ui_map_marker.remove()
                navigator.geolocation.clearWatch(pos_watcher)
                let new_pos = {
                    lat: position_now.coords.latitude,
                    lng: position_now.coords.longitude,
                    acc: position_now.coords.accuracy,
                    time: new Date().getTime()
                }
                positions.push(new_pos)
                renderMarkers([new_pos])
                savePositions(positions)
                info_panel.innerHTML = 'Location set'
            }

            function renderMarker() {
                ui_map_marker = L.marker([0, 0], {icon: icon})
                .bindPopup('<button onclick="setGeoPos()">Set</button>')
                .addTo(ui_map)
            }

            function getGeoPos() {
                flag_user_has_zoomed = false
                flag_is_tracking = true
                if ("geolocation" in navigator) {
                    renderMarker()
                    pos_watcher = navigator.geolocation.watchPosition(geo_success, geo_error, geo_options)
                } else {
                    info_panel.textContent = "Can't locate on this device."
                }
            }

            function loadSavedPositions() {
                positions = JSON.parse( localStorage.getItem('locator-positions-7718522f6d83') ) || []
                renderMarkers(positions)
            }

            function initListeners() {
                pos_btn.addEventListener('click', function() {
                    getGeoPos()
                })
                set_btn.addEventListener('click', function() {
                    setGeoPos()
                })
            }

            function initMap() {
                ui_map = L.map('map').setView([position_now.coords.latitude, position_now.coords.longitude], 6)
                ui_map.addEventListener('zoomstart', function() {
                    flag_user_has_zoomed = true
                })
                if (navigator.onLine) { // Only load map tiles if online
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                    }).addTo(ui_map)
                }
            }


            /*
             * Initialization
             */

            initListeners()
            initMap()
            loadSavedPositions()

        </script>

    </body>
</html>